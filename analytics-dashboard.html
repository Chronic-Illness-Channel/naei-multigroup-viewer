<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NAEI Viewer Analytics Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
    <style>
        body { font-family: system-ui, sans-serif; max-width: 1200px; margin: 0 auto; padding: 20px; background: #f5f5f5; }
        .dashboard { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; }
        .card { background: white; border-radius: 8px; padding: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .card h3 { margin-top: 0; color: #333; border-bottom: 2px solid #007cba; padding-bottom: 10px; }
        .metric { font-size: 24px; font-weight: bold; color: #007cba; }
        .table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        .table th, .table td { text-align: left; padding: 8px; border-bottom: 1px solid #ddd; }
        .table th { background: #f8f9fa; font-weight: 600; }
        .loading { text-align: center; padding: 40px; color: #666; }
        .error { background: #fee; color: #c33; padding: 15px; border-radius: 4px; margin: 10px 0; }
        .refresh-btn { background: #007cba; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; }
        .date-range { margin-bottom: 20px; }
        .date-range input { margin: 0 5px; padding: 5px; }
    </style>
</head>
<body>
    <h1>üìä NAEI Multi-Group Viewer - Analytics Dashboard</h1>
    
    <div class="date-range">
        <label>Date Range:</label>
        <input type="date" id="startDate">
        <input type="date" id="endDate">
        <button class="refresh-btn" onclick="loadAnalytics()">üîÑ Refresh</button>
        <span style="margin-left: 20px; color: #666;">Last updated: <span id="lastUpdated">Never</span></span>
    </div>

    <div id="loading" class="loading">üîÑ Loading analytics data...</div>
    <div id="error" class="error" style="display: none;"></div>
    <div id="dashboard" class="dashboard" style="display: none;"></div>

    <script>
        // Supabase connection (same as your main app)
        const SUPABASE_URL = 'https://vhplzwzzkeueyelaqftl.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZocGx6d3p6a2V1ZXllbGFxZnRsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA0NjQwODUsImV4cCI6MjA3NjA0MDA4NX0.mBAwFmfSpqffvp1GGDHKvp-y_hukSZmF4GN-Ghnf--o';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        // Set default date range (last 30 days)
        const endDate = new Date();
        const startDate = new Date();
        startDate.setDate(startDate.getDate() - 30);
        
        document.getElementById('endDate').value = endDate.toISOString().split('T')[0];
        document.getElementById('startDate').value = startDate.toISOString().split('T')[0];

        async function loadAnalytics() {
            const loading = document.getElementById('loading');
            const error = document.getElementById('error');
            const dashboard = document.getElementById('dashboard');
            
            loading.style.display = 'block';
            error.style.display = 'none';
            dashboard.style.display = 'none';

            try {
                const startDate = document.getElementById('startDate').value + 'T00:00:00Z';
                const endDate = document.getElementById('endDate').value + 'T23:59:59Z';

                // Get basic metrics
                const { data: events, error: eventsError } = await supabase
                    .from('analytics_events')
                    .select('*')
                    .gte('timestamp', startDate)
                    .lte('timestamp', endDate);

                if (eventsError) throw eventsError;

                // Get popular pollutants
                const { data: pollutants, error: pollutantsError } = await supabase
                    .from('popular_pollutants')
                    .select('*')
                    .limit(10);

                // Get popular groups  
                const { data: groups, error: groupsError } = await supabase
                    .from('popular_groups')
                    .select('*')
                    .limit(10);

                // Get export stats
                const { data: exports, error: exportsError } = await supabase
                    .from('export_stats')
                    .select('*')
                    .limit(20);

                // Calculate metrics
                const totalEvents = events.length;
                const uniqueSessions = new Set(events.map(e => e.session_id)).size;
                const uniqueUsers = new Set(events.map(e => e.user_fingerprint)).size;
                
                const eventTypes = {};
                events.forEach(e => {
                    eventTypes[e.event_type] = (eventTypes[e.event_type] || 0) + 1;
                });

                // Render dashboard
                dashboard.innerHTML = `
                    <div class="card">
                        <h3>üìà Overview</h3>
                        <p>Total Events: <span class="metric">${totalEvents}</span></p>
                        <p>Unique Sessions: <span class="metric">${uniqueSessions}</span></p>
                        <p>Unique Users: <span class="metric">${uniqueUsers}</span></p>
                    </div>

                    <div class="card">
                        <h3>üéØ Event Types</h3>
                        <table class="table">
                            <tr><th>Event</th><th>Count</th></tr>
                            ${Object.entries(eventTypes).map(([type, count]) => 
                                `<tr><td>${type}</td><td>${count}</td></tr>`
                            ).join('')}
                        </table>
                    </div>

                    <div class="card">
                        <h3>üß™ Popular Pollutants</h3>
                        <table class="table">
                            <tr><th>Pollutant</th><th>Views</th><th>Sessions</th></tr>
                            ${(pollutants || []).map(p => 
                                `<tr><td>${p.pollutant}</td><td>${p.views}</td><td>${p.unique_sessions}</td></tr>`
                            ).join('') || '<tr><td colspan="3">No data available</td></tr>'}
                        </table>
                    </div>

                    <div class="card">
                        <h3>üë• Popular Groups</h3>
                        <table class="table">
                            <tr><th>Group</th><th>Usage</th><th>Sessions</th></tr>
                            ${(groups || []).map(g => 
                                `<tr><td>${g.group_name}</td><td>${g.usage_count}</td><td>${g.unique_sessions}</td></tr>`
                            ).join('') || '<tr><td colspan="3">No data available</td></tr>'}
                        </table>
                    </div>

                    <div class="card">
                        <h3>‚¨áÔ∏è Download Statistics</h3>
                        <table class="table">
                            <tr><th>Format</th><th>Pollutant</th><th>Downloads</th></tr>
                            ${(exports || []).map(e => 
                                `<tr><td>${e.export_format}</td><td>${e.pollutant}</td><td>${e.download_count}</td></tr>`
                            ).join('') || '<tr><td colspan="3">No data available</td></tr>'}
                        </table>
                    </div>

                    <div class="card">
                        <h3>üìä Recent Activity</h3>
                        <table class="table">
                            <tr><th>Time</th><th>Event</th><th>Details</th></tr>
                            ${events.slice(-10).reverse().map(e => 
                                `<tr>
                                    <td>${new Date(e.timestamp).toLocaleString()}</td>
                                    <td>${e.event_type}</td>
                                    <td>${e.event_data?.pollutant || JSON.stringify(e.event_data).substr(0,50)}</td>
                                </tr>`
                            ).join('')}
                        </table>
                    </div>
                `;

                loading.style.display = 'none';
                dashboard.style.display = 'grid';
                document.getElementById('lastUpdated').textContent = new Date().toLocaleString();

            } catch (err) {
                console.error('Analytics error:', err);
                error.textContent = 'Failed to load analytics: ' + err.message;
                error.style.display = 'block';
                loading.style.display = 'none';
            }
        }

        // Load analytics on page load
        document.addEventListener('DOMContentLoaded', loadAnalytics);
        
        // Auto-refresh every 30 seconds
        setInterval(loadAnalytics, 30000);
    </script>
</body>
</html>