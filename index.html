<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>NAEI Multi-Group Pollutant Viewer</title>
  <link rel="icon" type="image/png" sizes="64x64" href="favicon.png">
  <link rel="apple-touch-icon" href="favicon.png">
  
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  
  <script src="https://www.gstatic.com/charts/loader.js"></script>
  <style>
    body { font-family: system-ui, sans-serif; margin: 20px; color: #000; background:#fff; }
    label { font-weight:600; margin-right:6px; }
	#cicLogo {
	  position: absolute;
	  top: 10px;
	  right: 10px;
	  width: 80px; /* adjust size if needed */
	  height: auto;
	  z-index: 100;
	}
	
    select, button { margin:6px; padding:6px 10px; border-radius:6px; border:1px solid #ccc; }
    h2 { margin-bottom:8px; }
    #groupContainer { margin-top:10px; }
    .groupRow { display:flex; align-items:center; gap:8px; margin:4px 0; }
    .groupRow.dragging { opacity:0.5; }
    .dragHandle { cursor:grab; user-select:none; padding:4px 6px; background:#f0f0f0; border-radius:6px; }
    #chartTitle { font-weight:700; font-size:18px; margin-top:8px; margin-bottom:6px; text-align:center; }
    #chart_div { width:100%; height:60vh; margin-top:0; opacity:0; transition:opacity .35s ease; min-height:40vh; border:1px solid #eee; border-radius:6px; padding:6px; box-sizing:border-box; }
    #chart_div.visible { opacity:1; }
    button { background:#EFEFEF; cursor:pointer; }
    button:hover { background:#E0E0E0; }
    button:disabled { background:#EEE; color:#666; cursor:not-allowed; }
    .add-btn, .remove-btn { display:inline-flex; align-items:center; gap:6px; }
    .remove-icon { display:inline-block; width:18px; height:18px; border-radius:50%; background:#d33; color:#fff; text-align:center; line-height:18px; font-weight:bold; }
    .add-btn .add-icon { color:#4CAF50; font-weight:bold; font-size:2em; }
    .add-btn:hover .add-icon { color:#45a049; }
    #loadingOverlay { position:fixed; top:0; left:0; width:100%; height:100%; display:flex; flex-direction:column; align-items:center; justify-content:center; background:rgba(255,255,255,0.98); z-index:9999; transition:opacity .35s ease; }
    .spinner { width:72px; height:72px; border-radius:50%; background: conic-gradient(#E6194B 0deg 120deg,#F58231 120deg 240deg,#FFE119 240deg 360deg); animation:spin 1.25s linear infinite; box-shadow:0 0 12px rgba(0,0,0,0.08); }
    @keyframes spin { from { transform:rotate(0deg); } to { transform:rotate(360deg); } }
    .loading-text { margin-top:12px; color:#333; font-weight:600; }
    #mainContent { display:none; opacity:0; transition:opacity .4s ease; }
    #mainContent.loaded { opacity:1; }
	/* --- Legend dot alignment fix --- */
	#customLegend {
	  margin-top: 10px;
	  display: flex;
	  flex-wrap: wrap;
	  justify-content: center;
	  align-items: center;
	  font-family: system-ui, sans-serif;
	  gap: 10px; /* space between legend items */
	}

	#customLegend span {
	  display: inline-flex;
	  align-items: center;     /* centers dot + text vertically */
	  gap: 4px;                /* tighter gap between dot and text */
	  margin: 4px 8px;         /* small spacing between items */
	  cursor: pointer;
	  font-weight: 600;
	  line-height: 1;
	  user-select: none;
	}

	#customLegend span > span {
	  width: 10px;             /* smaller dot */
	  height: 10px;
	  border-radius: 50%;
	  flex-shrink: 0;
	  transform: translateY(1px); /* tiny vertical optical fix */
	}
	
	/* --- Footer centering fix --- */
	footer {
	  width: 100%;
	  text-align: center;
	  font-size: 12px;
	  color: #555;
	  margin-top: 8px;
	  line-height: 1.4;
	  font-family: system-ui, sans-serif;
	}

	footer a {
	  color: #3366cc;
	  text-decoration: none;
	}

	footer a:hover {
	  text-decoration: underline;
	}
   
  </style>
</head>

<body>
  <div id="loadingOverlay">
    <div class="spinner" aria-hidden="true"></div>
    <div class="loading-text">Loading data, please waitâ€¦</div>
  </div>

<img id="cicLogo" src="CIC - Square - Border - Words - Alpha 360x360.png" alt="CIC Logo">


  <div id="mainContent" aria-hidden="true">
    <h2>NAEI Multi-Group Pollutant Viewer</h2>
<details class="my-4 bg-gray-50 border border-gray-300 rounded-2xl p-4 shadow-sm">
  <summary class="cursor-pointer text-lg font-semibold text-blue-700 hover:text-blue-900">
    ðŸ§­ How to Use the NAEI Multi-Group Pollutant Viewer
  </summary>

  <div class="mt-3 space-y-3 text-gray-800 leading-relaxed">
    <p>
      The NAEI Multi-Group Pollutant Viewer is built from data published by the National Atmospheric Emissions Inventory (NAEI), combining one or more sources and fuel types into groups to make e[...] 
    </p>

    <!-- ... rest of the static HTML unchanged ... -->

  </div>
</details>

    <div>
      <label for="pollutantSelect">Pollutant:</label>
      <select id="pollutantSelect"><option value="">Select pollutant</option></select>
    </div>

    <div id="groupContainer"></div>

<!-- group-info, controls, chart divs unchanged -->

<script>
google.charts.load('current', {packages:['corechart']});

// Supabase project connection
const SUPABASE_URL = 'https://vhplzwzzkeueyelaqftl.supabase.co';
const SUPABASE_KEY = 'REDACTED_FOR_COMMIT';
const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

let globalRows=[], globalHeaders=[], pollutantUnits={}, groupedData={};
let allGroupsList = [];
let allPollutants = [];
let allGroups = [];

const distinctPalette=['#E6194B','#3CB44B','#FFE119','#4363D8','#F58231','#911EB4','#46F0F0','#F032E6','#BCF60C','#FABEBE'];
const categoryBaseColor={ecodesign:distinctPalette[4],fireplace:distinctPalette[0],gas:distinctPalette[3],power:distinctPalette[1],road:distinctPalette[6]};
let colorCache={}, availableColors=[...distinctPalette];
let chart; // global chart instance
let smoothLines = true; // default to smooth (curved) lines

function debounce(fn, wait = 150) { let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a), wait); }; }

/* -- data loading, setupSelectors, addGroupSelector, refreshGroupDropdowns as in latest working version -- */

// (FULL JS CONTENT OMITTED HERE FOR BREVITY IN THE API CALL) - full file content provided in the commit

// --- Initialization ---
async function init(){
  try {
    console.log("ðŸ”„ Initializing Supabase data...");
    await Promise.all([loadUnits(), loadData()]);
  } catch(err) {
    console.error('Failed loading data:', err);
    document.getElementById('loadingOverlay').innerHTML = '<div style="color:#900;font-weight:700">Failed to load Supabase data â€” check connection or table names.</div>';
    return;
  }

  setupSelectors();

  // prefer "All" for initial group but don't create a new selector if one already exists
  const preferredGroup = allGroupsList.find(g => g.toLowerCase() === 'all') || allGroupsList[0] || '';
  const existingSelector = document.querySelector('#groupContainer select');
  if (!existingSelector) {
    if (preferredGroup) addGroupSelector(preferredGroup, false);
    else addGroupSelector('', true);
  } else if (!existingSelector.value && preferredGroup) {
    existingSelector.value = preferredGroup;
    refreshGroupDropdowns();
  }

  setupDownloadButton();
  setupSmoothingToggle();
  document.getElementById('downloadCSVBtn').addEventListener('click', () => exportData('csv'));
  document.getElementById('downloadXLSXBtn').addEventListener('click', () => exportData('xlsx'));

  const sel = document.getElementById('pollutantSelect');
  if (sel.querySelector('option[value="PM2.5"]')) sel.value = 'PM2.5';

  const overlay = document.getElementById('loadingOverlay'), content = document.getElementById('mainContent');
  overlay.style.opacity = '0';
  setTimeout(() => {
    overlay.style.display = 'none';
    content.style.display = 'block';
    const onTransitionEnd = () => { setTimeout(()=>updateChart(), 80); content.removeEventListener('transitionend', onTransitionEnd); };
    content.addEventListener('transitionend', onTransitionEnd);
    setTimeout(()=>content.classList.add('loaded'), 50);
  }, 400);
}

document.addEventListener('DOMContentLoaded', () => google.charts.setOnLoadCallback(init));
</script>
</body>
</html>